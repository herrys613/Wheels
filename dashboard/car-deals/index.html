<!DOCTYPE html>
<html lang="en" class="scroll-smooth">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Car Deals Database | Dashboard</title>
    <meta name="description" content="Administrative area for Car Deals. Authorized access only.">

    <meta property="og:type" content="website">
    <meta property="og:title" content="Car Deals Database | Dashboard">
    <meta property="og:description" content="Administrative area for Car Deals. Authorized access only.">

    <link rel="icon" type="image/png" href="/images/favicon.png" sizes="32x32">

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/style.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="/tailwind.config.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
</head>

<style>
    .table-container {
        max-height: calc(100vh - 345px);
        overflow: auto;
        scrollbar-width: none;
        -ms-overflow-style: none;
    }

    .table-container::-webkit-scrollbar {
        display: none;
    }

    .sticky-header {
        position: sticky;
        top: 0;
        background: white;
        z-index: 10;
    }

    .status-badge {
        display: inline-block;
        width: 70px;
        text-align: center;
        padding: 2px 8px;
        border-radius: 4px;
        font-size: 12px;
        font-weight: 500;
    }

    .status-inactive {
        background: #fef3c7;
        color: #92400e;
    }

    .status-active {
        background: #d1fae5;
        color: #065f46;
    }

    /* Table Column Widths */
    table {
        table-layout: fixed;
        width: 100%;
    }

    table th:nth-child(1),
    table td:nth-child(1) {
        width: 20px;
    }

    /* Status */
    table th:nth-child(2),
    table td:nth-child(2) {
        width: 70px;
    }

    /* Car Name */
    table th:nth-child(3),
    table td:nth-child(3) {
        width: 150px;
    }

    /* Label */
    table th:nth-child(4),
    table td:nth-child(4) {
        width: 80px;
    }

    /* Price */
    table th:nth-child(5),
    table td:nth-child(5) {
        width: 60px;
    }

    /* Term */
    table th:nth-child(6),
    table td:nth-child(6) {
        width: 60px;
    }

    /* Mailage */
    table th:nth-child(7),
    table td:nth-child(7) {
        width: 60px;
    }

    /* Due */
    table th:nth-child(8),
    table td:nth-child(8) {
        width: 60px;
    }

    /* Expires */
    table th:nth-child(9),
    table td:nth-child(9) {
        width: 100px;
    }

    /* Actions */
    table th:nth-child(10),
    table td:nth-child(10) {
        width: 60px;
    }

    table td {
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }
</style>

<body class="flex flex-col min-h-screen" x-data="{ isOpen: false }">
    <!-- Navbar -->
    <header class="bg-white border-b border-gray-200">
        <nav class="max-w-[2000px] p-5 mx-auto lg:px-8 lg:py-5">
            <div class="flex justify-between items-center relative">
                <a href="/">
                    <img class="h-5 sm:h-7" src="/images/logo-blue.png" alt="logo">
                </a>

                <div class="hidden lg:flex absolute left-1/2 transform -translate-x-1/2 space-x-12">
                    <a href="/" class="text-gray-600 hover:text-blue-600 transition-colors duration-300">Home</a>
                    <a href="/leasing-deals/"
                        class="text-gray-600 hover:text-blue-600 transition-colors duration-300">Leasing Deals</a>
                    <a href="/about-us/" class="text-gray-600 hover:text-blue-600 transition-colors duration-300">About
                        us</a>
                    <a href="/blog/" class="text-gray-600 hover:text-blue-600 transition-colors duration-300">Blog</a>
                    <a href="/contact/"
                        class="text-gray-600 hover:text-blue-600 transition-colors duration-300">Contact</a>
                </div>

                <div class="hidden lg:flex items-center">
                    <a class="logout-btn block px-5 py-2 mt-4 text-sm text-center text-white capitalize bg-red-600 rounded-lg lg:mt-0 hover:bg-red-500 lg:w-auto"
                        href="#">
                        Log out
                    </a>
                </div>

                <div class="flex lg:hidden">
                    <button x-cloak @click="isOpen = !isOpen" type="button"
                        class="text-gray-800 hover:text-gray-900 focus:outline-none" aria-label="toggle menu">
                        <svg x-show="!isOpen" xmlns="http://www.w3.org/2000/svg" class="w-6 h-6" fill="none"
                            viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M4 8h16M4 16h16" />
                        </svg>
                        <svg x-show="isOpen" xmlns="http://www.w3.org/2000/svg" class="w-6 h-6" fill="none"
                            viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                </div>
            </div>
        </nav>
    </header>

    <div class="flex flex-1 relative">
        <!-- Dashboard Sidebar -->
        <aside class="hidden lg:block w-72 bg-white border-r border-gray-200">
            <div class="p-6">
                <h2 class="text-lg font-semibold text-gray-900 mb-6">Dashboard</h2>
                <nav class="space-y-2">
                    <a href="/dashboard/"
                        class="flex items-center px-4 py-3 text-gray-600 rounded-lg hover:bg-gray-50 hover:text-gray-900 transition-colors">
                        <i class="fas fa-chart-pie w-5 mr-3"></i>
                        <span class="font-medium">Overview</span>
                    </a>
                    <a href="/dashboard/car-deals/"
                        class="flex items-center px-4 py-3 text-blue-600 bg-blue-50 rounded-lg">
                        <i class="fas fa-car w-5 mr-3"></i>
                        <span class="font-medium">Car Deals</span>
                    </a>
                    <a href="/dashboard/leasing-calculator/"
                        class="flex items-center px-4 py-3 text-gray-600 rounded-lg hover:bg-gray-50 hover:text-gray-900 transition-colors">
                        <i class="fas fa-calculator w-5 mr-3"></i>
                        <span class="font-medium">Leasing Calculator</span>
                    </a>
                    <a href="#"
                        class="flex items-center px-4 py-3 text-gray-600 rounded-lg hover:bg-gray-50 hover:text-gray-900 transition-colors">
                        <i class="fas fa-cog w-5 mr-3"></i>
                        <span class="font-medium">Settings</span>
                    </a>
                </nav>
            </div>
            <hr class="my-6 border-gray-200" />
            <a href="#" class="flex items-center px-4 -mx-2">
                <img class="object-cover mx-2 rounded-full h-9 w-9" src="/images/default-avatar.png" alt="avatar" />
                <span class="mx-2 font-medium text-gray-800 truncate">admin@cardeals.com</span>
            </a>
        </aside>

        <!-- Mobile Sidebar -->
        <aside
            class="absolute top-0 left-0 px-6 py-5 h-full z-50 w-2/3 bg-white shadow-lg transform transition-transform duration-500 -translate-x-full lg:hidden"
            :class="[isOpen ? 'translate-x-0 opacity-100' : 'opacity-0 -translate-x-full']">
            <div class="space-y-4">
                <a href="/"
                    class="block text-gray-600 hover:text-blue-600 font-medium transition-colors duration-300">Home</a>
                <a href="/leasing-deals/"
                    class="block text-gray-600 hover:text-blue-600 font-medium transition-colors duration-300">Leasing
                    Deals</a>
                <a href="/about-us/"
                    class="block text-gray-600 hover:text-blue-600 font-medium transition-colors duration-300">About
                    us</a>
                <a href="/blog/"
                    class="block text-gray-600 hover:text-blue-600 font-medium transition-colors duration-300">Blog</a>
                <a href="/contact/"
                    class="block text-gray-600 hover:text-blue-600 font-medium transition-colors duration-300">Contact</a>
                <hr class="my-4 border-gray-200">
                <h3 class="text-sm font-semibold text-gray-500 uppercase tracking-wide mb-2">Dashboard</h3>
                <a class="flex items-center text-gray-600 hover:text-blue-600" href="/dashboard/">
                    <i class="fas fa-chart-pie mr-2 w-5"></i>Overview
                </a>
                <a class="flex items-center text-blue-600" href="/dashboard/car-deals/">
                    <i class="fas fa-car mr-2 w-5"></i>Car Deals
                </a>
                <a class="flex items-center text-gray-600 hover:text-blue-600" href="/dashboard/leasing-calculator/">
                    <i class="fas fa-calculator mr-2 w-5"></i>Leasing Calculator
                </a>
                <a class="flex items-center text-gray-600 hover:text-blue-600" href="#">
                    <i class="fa-solid fa-gear mr-2 w-5"></i>Settings
                </a>
                <a class="logout-btn block px-5 py-2 mt-4 text-sm text-center text-white capitalize bg-red-600 rounded-lg hover:bg-red-500"
                    href="#">
                    Log out
                </a>
            </div>
        </aside>

        <!-- Main Section -->
        <main class="bg-zinc-50 flex-1 p-4 lg:p-8">
            <!-- Status Cards -->
            <div class="grid grid-cols-2 lg:grid-cols-4 gap-6 mb-5">
                <div class="bg-white rounded-xl shadow-sm p-4">
                    <div class="flex items-start gap-4">
                        <div class="w-12 h-12 rounded-xl bg-blue-100 flex items-center justify-center flex-shrink-0">
                            <i class="fas fa-car text-blue-600 text-xl"></i>
                        </div>
                        <div>
                            <div class="text-xl font-bold text-gray-900" id="total-count">0</div>
                            <div class="text-xs text-gray-500 mt-1">Total Deals</div>
                        </div>
                    </div>
                </div>

                <div class="bg-white rounded-xl shadow-sm p-4">
                    <div class="flex items-start gap-4">
                        <div class="w-12 h-12 rounded-xl bg-blue-100 flex items-center justify-center flex-shrink-0">
                            <i class="fas fa-clock text-blue-600 text-xl"></i>
                        </div>
                        <div>
                            <div class="text-xl font-bold text-gray-900" id="inactive-count">0</div>
                            <div class="text-xs text-gray-500 mt-1">Inactive</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Controls Bar -->
            <div class="bg-white rounded-lg shadow p-4 mb-6">
                <div class="flex flex-wrap items-center justify-between gap-4">
                    <div class="flex items-center gap-4 flex-1 max-w-xl">
                        <div class="relative flex-1">
                            <input type="text" id="search-input" placeholder="Search by car name, make, or label..."
                                class="w-full px-4 py-2 pl-10 pr-10 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-600">
                            <i
                                class="fas fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                            <button id="clear-search"
                                class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-gray-600 hidden">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>

                        <div class="relative" x-data="{ open: false }">
                            <button @click="open = !open" @click.away="open = false"
                                class="flex items-center gap-2 px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 focus:outline-none focus:ring-1 focus:ring-blue-500 transition-colors">
                                <i class="fas fa-filter text-gray-500"></i>
                                <span id="status-label">All Status</span>
                                <i class="fas fa-chevron-down text-xs text-gray-500 transition-transform"
                                    :class="{ 'rotate-180': open }"></i>
                            </button>

                            <div x-show="open" style="display: none;"
                                x-transition:enter="transition ease-out duration-200"
                                x-transition:enter-start="opacity-0 scale-95"
                                x-transition:enter-end="opacity-100 scale-100"
                                class="absolute top-full left-0 mt-2 w-48 bg-white border border-gray-200 rounded-lg shadow-lg z-20">
                                <div class="py-1">
                                    <button onclick="filterByStatus('', 'All Status')"
                                        class="w-full text-left px-4 py-2 text-gray-700 hover:bg-gray-50">All
                                        Status</button>
                                    <button onclick="filterByStatus('active', 'Active')"
                                        class="w-full text-left px-4 py-2 text-gray-700 hover:bg-gray-50">Active</button>
                                    <button onclick="filterByStatus('inactive', 'Inactive')"
                                        class="w-full text-left px-4 py-2 text-gray-700 hover:bg-gray-50">Inactive</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="flex gap-2">
                        <button id="add-new-deal-btn"
                            class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 flex items-center gap-2">
                            <i class="fas fa-plus"></i> Add New Deal
                        </button>
                        <button id="export-csv"
                            class="px-4 py-2 bg-gray-100 rounded-lg hover:bg-gray-200 flex items-center gap-2">
                            <i class="fas fa-file-csv"></i> Export CSV
                        </button>
                    </div>
                </div>
            </div>

            <!-- Table -->
            <div class="bg-white rounded-lg shadow overflow-hidden">
                <div class="hidden md:block table-container">
                    <table class="w-full">
                        <thead class="sticky-header">
                            <tr class="border-b">
                                <th
                                    class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    #</th>
                                <th
                                    class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    Status</th>
                                <th
                                    class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    Car Name</th>
                                <th
                                    class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    Label</th>
                                <th
                                    class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    Price</th>
                                <th
                                    class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    Term</th>
                                <th
                                    class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    Mileage</th>
                                <th
                                    class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    Due</th>
                                <th
                                    class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    Expiration Date</th>
                                <th
                                    class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    Actions</th>
                            </tr>
                        </thead>
                        <tbody id="deals-tbody" class="bg-white divide-y divide-gray-200">
                            <tr id="loading-row">
                                <td colspan="9" class="px-4 py-8 text-center">
                                    <div class="loading-dots">
                                        <div class="loading-dot"></div>
                                        <div class="loading-dot"></div>
                                        <div class="loading-dot"></div>
                                        <div class="loading-dot"></div>
                                    </div>
                                    <p class="mt-2 text-gray-500">Loading Deals...</p>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <!-- Mobile Cards -->
                <div id="mobile-cards" class="md:hidden divide-y divide-gray-200 h-[70vh] overflow-auto hide-scrollbar">
                    <div id="mobile-loading" class="px-4 py-8 text-center">
                        <div class="loading-dots">
                            <div class="loading-dot"></div>
                            <div class="loading-dot"></div>
                            <div class="loading-dot"></div>
                            <div class="loading-dot"></div>
                        </div>
                        <p class="mt-2 text-gray-500">Loading Deals...</p>
                    </div>
                </div>
            </div>

            <!-- Details Modal -->
            <div id="details-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50"
                onclick="closeDetailsModal()">
                <div class="bg-white rounded-xl shadow-xl max-w-lg w-full mx-4 overflow-hidden"
                    onclick="event.stopPropagation()">
                    <div class="border-b px-6 py-4 flex justify-between items-center">
                        <div class="flex items-center gap-3">
                            <h2 class="text-xl font-bold">Deal Details</h2>
                            <button id="edit-btn"
                                class="px-2 py-1 bg-blue-600 text-white text-xs rounded-lg hover:bg-blue-700">
                                <i class="fas fa-edit mr-2"></i>Edit
                            </button>
                        </div>
                        <button id="close-modal-btn" class="text-gray-400 hover:text-gray-600">
                            <i class="fas fa-times text-xl"></i>
                        </button>
                    </div>
                    <div class="h-[70vh] overflow-y-auto custom-scroll">
                        <div id="modal-content" class="p-6"></div>
                    </div>
                    <div id="edit-actions" class="hidden sticky bottom-0 border-t px-6 py-4 justify-end gap-2 bg-white">
                        <button id="cancel-edit-btn"
                            class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300">Cancel</button>
                        <button id="save-edit-btn"
                            class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">
                            <i class="fas fa-save mr-2"></i>Save Changes
                        </button>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Delete Modal -->
    <div id="delete-modal" class="fixed inset-0 z-50 items-center justify-center bg-black bg-opacity-50 hidden">
        <div class="bg-white rounded-xl shadow-2xl max-w-md w-full mx-4">
            <div class="p-6">
                <div class="flex items-center mb-4">
                    <div class="w-12 h-12 bg-red-100 rounded-full flex items-center justify-center mr-4">
                        <i class="fas fa-trash-alt text-red-600 text-xl"></i>
                    </div>
                    <div>
                        <h3 class="text-lg font-semibold text-gray-900">Delete Deal</h3>
                        <p class="text-sm text-gray-600">This action cannot be undone</p>
                    </div>
                </div>
                <p class="text-gray-700 mb-6">Are you sure you want to delete this car deal? All associated data and
                    images will be permanently removed.</p>
                <div class="flex gap-3">
                    <button id="cancel-delete"
                        class="flex-1 px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 font-medium">Cancel</button>
                    <button id="confirm-delete"
                        class="flex-1 px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 font-medium">Delete</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-storage-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-auth-compat.js"></script>

    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyC25Tdl5GtnRXcHeBBGeIOuIcVX_WdiHP4",
            authDomain: "cars-8bdd6.firebaseapp.com",
            projectId: "cars-8bdd6",
            storageBucket: "cars-8bdd6.appspot.com",
            messagingSenderId: "597823500976",
            appId: "1:597823500976:web:71f23d89e38a5cdb010175"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const storage = firebase.storage();
        const auth = firebase.auth();

        db.enablePersistence({ synchronizeTabs: true })
            .catch((err) => {
                if (err.code === 'failed-precondition') {
                    console.log('Multiple tabs open, persistence can only be enabled in one tab');
                } else if (err.code === 'unimplemented') {
                    console.log('Browser doesn\'t support persistence');
                }
            });

        // Protect the page
        auth.onAuthStateChanged((user) => {
            if (!user) {
                window.location.href = "/login/";
                return;
            }
            loadDeals();
        });

        // Logout
        document.querySelectorAll('.logout-btn').forEach(btn => {
            btn.addEventListener('click', async (e) => {
                e.preventDefault();
                btn.textContent = "Logging out...";
                btn.disabled = true;
                try {
                    await firebase.auth().signOut();
                    window.location.href = "/login/";
                } catch (error) {
                    console.error("Logout error:", error);
                    alert("Error logging out. Try again.");
                }
            });
        });

        const COLLECTION_NAME = 'cars';
        let allDeals = [];
        let filteredDeals = [];
        let currentEditingDeal = null;
        let isEditMode = false;

        async function loadDeals() {
            try {
                const snapshot = await db.collection(COLLECTION_NAME).get();
                allDeals = [];

                snapshot.forEach((doc) => {
                    const data = doc.data();
                    allDeals.push({
                        id: doc.id,
                        ...data,
                        timestamp: data.timestamp?.toDate ? data.timestamp.toDate() : new Date(data.timestamp || Date.now()),
                        status: data.status || 'pending'
                    });
                });

                allDeals.sort((a, b) => b.timestamp - a.timestamp);
                filteredDeals = [...allDeals];
                updateStats();
                renderTable();
                document.getElementById('loading-row').style.display = 'none';

                if (allDeals.length === 0) {
                    document.getElementById('deals-tbody').innerHTML = `
                        <tr>
                            <td colspan="9" class="px-4 py-8 text-center text-gray-500">No deals found.</td>
                        </tr>
                    `;
                }
            } catch (error) {
                console.error('Error loading deals:', error);
                document.getElementById('loading-row').innerHTML = `
                    <td colspan="9" class="px-4 py-8 text-center text-red-500">
                        <p class="font-bold mb-2">Error loading data</p>
                        <p class="text-sm">${error.message}</p>
                    </td>
                `;
            }
        }

        function updateStats() {
            const total = allDeals.length;
            const inactive = allDeals.filter(l => l.status === 'inactive').length;
            const active = allDeals.filter(l => l.status === 'active').length;

            document.getElementById('total-count').textContent = total;
            document.getElementById('inactive-count').textContent = inactive;
        }

        function renderTable() {
            const tbody = document.getElementById('deals-tbody');
            const mobileCards = document.getElementById('mobile-cards');
            const mobileLoading = document.getElementById('mobile-loading');

            if (filteredDeals.length === 0) {
                tbody.innerHTML = `<tr><td colspan="9" class="px-4 py-8 text-center text-gray-500">No deals found</td></tr>`;
                if (mobileLoading) mobileLoading.style.display = 'none';
                mobileCards.innerHTML = `<div class="px-4 py-8 text-center text-gray-500">No deals found</div>`;
                return;
            }

            if (mobileLoading) mobileLoading.style.display = 'none';

            // Desktop table
            tbody.innerHTML = filteredDeals.map((deal, index) => {
                const status = deal.status || 'inactive';
                const statusClass = `status-${status}`;

                return `
                    <tr class="hover:bg-gray-50">
                        <td class="px-4 py-3 text-sm">${index + 1}</td>
                        <td class="px-4 py-3">
                            <span class="status-badge ${statusClass}">
                                ${status.charAt(0).toUpperCase() + status.slice(1)}
                            </span>
                        </td>
                        <td class="px-4 py-3 text-sm font-medium">
                            ${deal.car?.name || deal.car?.make || '-'}
                        </td>
                        <td class="px-4 py-3 text-sm">
                            ${deal.details.label || '-'}
                        </td>
                        <td class="px-4 py-3 text-sm">
                            $${deal.pricing.price || '-'}
                        </td>
                        
                        <td class="px-4 py-3 text-sm">
                            ${deal.details?.term || '-'} mo
                        </td>
                        <td class="px-4 py-3 text-sm">
                            ${deal.details?.mileage || '-'}
                        </td>
                        <td class="px-4 py-3 text-sm font-medium">
                            $${deal.pricing?.due || '-'}
                        </td>
                        <td class="px-4 py-3 text-sm">${formatDate(deal.timestamp)}</td>
                        <td class="px-4 py-3 text-sm text-center">
                            <div class="flex justify-center gap-2">
                                <button onclick="viewDetails('${deal.id}')" class="text-gray-600 hover:text-blue-800">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <button onclick="deleteListing('${deal.id}')" class="text-gray-600 hover:text-red-800">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');

            // Mobile cards
            mobileCards.innerHTML = filteredDeals.map((deal, index) => {
                const status = deal.status || 'pending';
                const statusClass = `status-${status}`;

                return `
                    <div class="p-4 hover:bg-gray-50 cursor-pointer" onclick="viewDetails('${deal.id}')">
                        <div class="flex items-start justify-between mb-2">
                            <div class="flex-1">
                                <div class="flex items-center gap-2 mb-1">
                                    <span class="status-badge ${statusClass}">
                                        ${status.charAt(0).toUpperCase() + status.slice(1)}
                                    </span>
                                </div>
                                <h3 class="font-semibold text-gray-900">${deal.car?.name || deal.car?.make || '-'}</h3>
                            </div>
                            <button onclick="event.stopPropagation(); deleteListing('${deal.id}')" class="text-gray-400 hover:text-red-600 p-2">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                        <div class="space-y-2 text-sm">
                            <div class="flex items-center text-gray-600">
                                <i class="fas fa-dollar-sign w-5 text-gray-400"></i>
                                <span>$${deal.pricing?.due || '-'}/mo</span>
                            </div>
                            <div class="flex items-center text-gray-600">
                                <i class="fas fa-calendar w-5 text-gray-400"></i>
                                <span>${deal.details?.term || '-'}/mo</span>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function formatDate(date) {
            if (!date) return '-';
            return new Date(date).toLocaleDateString('en-US', {
                month: 'short',
                day: 'numeric',
                year: 'numeric'
            });
        }

        function formatDateTime(date) {
            if (!date) return '-';
            return new Date(date).toLocaleString('en-US', {
                month: 'short',
                day: 'numeric',
                year: 'numeric',
                hour: 'numeric',
                minute: '2-digit',
                hour12: true
            });
        }

        // Search
        let currentStatusFilter = '';

        document.getElementById('search-input').addEventListener('input', (e) => {
            const searchTerm = e.target.value.toLowerCase();
            const clearButton = document.getElementById('clear-search');

            if (searchTerm.length > 0) {
                clearButton.classList.remove('hidden');
            } else {
                clearButton.classList.add('hidden');
            }

            filteredDeals = allDeals.filter(deal => {
                const carName = (deal.car?.name || '').toLowerCase();
                const make = (deal.car?.make || '').toLowerCase();
                const label = (deal.details?.label || '').toLowerCase();

                return carName.includes(searchTerm) || make.includes(searchTerm) || label.includes(searchTerm);
            });

            applyStatusFilter();
        });

        document.getElementById('clear-search').addEventListener('click', () => {
            const searchInput = document.getElementById('search-input');
            searchInput.value = '';
            document.getElementById('clear-search').classList.add('hidden');
            filteredDeals = [...allDeals];
            applyStatusFilter();
            searchInput.focus();
        });

        function filterByStatus(status, label) {
            currentStatusFilter = status;
            document.getElementById('status-label').textContent = label;
            applyStatusFilter();
        }

        function applyStatusFilter() {
            const searchTerm = document.getElementById('search-input').value.toLowerCase();

            filteredDeals = allDeals.filter(deal => {
                const carName = (deal.car?.name || '').toLowerCase();
                const make = (deal.car?.make || '').toLowerCase();
                const label = (deal.details?.label || '').toLowerCase();

                return carName.includes(searchTerm) || make.includes(searchTerm) || label.includes(searchTerm);
            });

            if (currentStatusFilter) {
                filteredDeals = filteredDeals.filter(l => l.status === currentStatusFilter);
            }

            updateStats();
            renderTable();
        }

        // View Details
        function viewDetails(id) {
            currentEditingDeal = allDeals.find(l => l.id === id);
            if (!currentEditingDeal) return;

            isEditMode = false;
            renderModalContent();

            const scrollbarWidth = window.innerWidth - document.documentElement.clientWidth;
            document.body.style.paddingRight = `${scrollbarWidth}px`;
            document.body.style.overflow = 'hidden';

            const modal = document.getElementById('details-modal');
            modal.style.display = 'flex';

            setupModalEventListeners();
        }

        function closeDetailsModal() {
            const modal = document.getElementById('details-modal');
            modal.style.display = 'none';
            isEditMode = false;
            document.querySelector('#details-modal h2').textContent = 'Deal Details';
            document.body.style.paddingRight = '';
            document.body.style.overflow = '';
        }

        function setupModalEventListeners() {
            const closeBtn = document.getElementById('close-modal-btn');
            if (closeBtn) closeBtn.onclick = closeDetailsModal;

            const editBtn = document.getElementById('edit-btn');
            if (editBtn) editBtn.onclick = toggleEditMode;

            const cancelBtn = document.getElementById('cancel-edit-btn');
            if (cancelBtn) cancelBtn.onclick = cancelEdit;

            const saveBtn = document.getElementById('save-edit-btn');
            if (saveBtn) saveBtn.onclick = (e) => saveEdit(e);
        }

        function toggleEditMode() {
            isEditMode = !isEditMode;
            renderModalContent();
            setupModalEventListeners();
        }

        function cancelEdit() {
            // If it's a new deal (no ID), close the modal completely
            if (!currentEditingDeal.id) {
                closeDetailsModal();
                return;
            }

            // Otherwise, just switch back to view mode
            isEditMode = false;
            renderModalContent();
            setupModalEventListeners();
        }

        async function saveEdit(event) {
            const deal = currentEditingDeal;
            const isNewDeal = !deal.id;

            const updatedData = {
                car: {
                    make: document.getElementById('edit-make').value,
                    name: document.getElementById('edit-name').value
                },
                details: {
                    label: document.getElementById('edit-label').value,
                    mileage: document.querySelector('[data-name="edit-mileage"]').selectedValue || '',
                    term: document.querySelector('[data-name="edit-term"]').selectedValue || '',
                    exteriorColor: document.querySelector('[data-name="edit-exteriorColor"]').selectedValue || '',
                    interiorColor: document.querySelector('[data-name="edit-interiorColor"]').selectedValue || '',
                    features: document.getElementById('edit-features').value
                },
                pricing: {
                    price: parseFloat(document.getElementById('edit-price').value) || 0,
                    due: parseFloat(document.getElementById('edit-due').value) || 0
                },
                status: document.getElementById('edit-status').checked ? 'active' : 'inactive',
                images: deal.images || []
            };

            const saveBtn = event?.target || event?.currentTarget;

            try {
                if (saveBtn) {
                    saveBtn.innerHTML = isNewDeal
                        ? '<i class="fas fa-spinner fa-spin mr-2"></i>Adding...'
                        : '<i class="fas fa-spinner fa-spin mr-2"></i>Saving...';
                    saveBtn.disabled = true;
                }

                if (isNewDeal) {
                    updatedData.timestamp = firebase.firestore.FieldValue.serverTimestamp();
                    const docRef = await db.collection(COLLECTION_NAME).add(updatedData);
                    const newDeal = {
                        id: docRef.id,
                        ...updatedData,
                        timestamp: new Date()
                    };
                    allDeals.unshift(newDeal);
                    alert('New deal added successfully!');
                } else {
                    await db.collection(COLLECTION_NAME).doc(deal.id).update(updatedData);
                    const index = allDeals.findIndex(l => l.id === deal.id);
                    if (index !== -1) {
                        allDeals[index] = { ...allDeals[index], ...updatedData };
                    }
                    alert('Deal updated successfully!');
                }

                currentEditingDeal = isNewDeal
                    ? { id: null, ...updatedData }
                    : { ...currentEditingDeal, ...updatedData };

                applyStatusFilter();
                closeDetailsModal();

            } catch (error) {
                console.error('Error saving deal:', error);
                alert('Error saving deal: ' + error.message);
            } finally {
                if (saveBtn) {
                    saveBtn.innerHTML = '<i class="fas fa-save mr-2"></i>Save Changes';
                    saveBtn.disabled = false;
                }
            }
        }

        // Handle image upload
        document.addEventListener('change', async (e) => {
            if (e.target.id === 'image-upload') {
                const files = Array.from(e.target.files);
                const uploadStatus = document.getElementById('upload-status');
                const previewGrid = document.getElementById('image-preview-grid');

                if (files.length === 0) return;

                uploadStatus.classList.remove('hidden');
                uploadStatus.textContent = 'Uploading images...';

                try {
                    const uploadedUrls = await uploadImagesToFirebase(files);

                    // Add new images to current deal
                    currentEditingDeal.images = [...(currentEditingDeal.images || []), ...uploadedUrls];

                    // Re-render the image grid
                    previewGrid.innerHTML = currentEditingDeal.images.map((img, index) => `
                <div class="relative group">
                    <img src="${img}" alt="Car" class="w-full h-32 object-cover rounded-lg border">
                    <button type="button" onclick="removeImage(${index})" 
                        class="absolute top-2 right-2 bg-red-600 text-white rounded-full w-6 h-6 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity">
                        <i class="fas fa-times text-xs"></i>
                    </button>
                </div>
            `).join('');

                    previewGrid.classList.remove('hidden');
                    uploadStatus.textContent = `${files.length} image(s) uploaded successfully!`;
                    uploadStatus.className = 'text-sm text-green-600';

                    setTimeout(() => uploadStatus.classList.add('hidden'), 3000);

                    // Clear input
                    e.target.value = '';

                } catch (error) {
                    console.error('Upload error:', error);
                    uploadStatus.textContent = 'Error uploading images. Please try again.';
                    uploadStatus.className = 'text-sm text-red-600';
                }
            }
        });

        // Upload images to Firebase Storage
        async function uploadImagesToFirebase(files) {
            const uploadedUrls = [];

            for (const file of files) {
                // Create unique filename with timestamp
                const timestamp = Date.now();
                const filename = `car-deals/${timestamp}_${file.name}`;

                // Upload to Firebase Storage
                const storageRef = storage.ref(filename);
                const snapshot = await storageRef.put(file);

                // Get download URL
                const downloadURL = await snapshot.ref.getDownloadURL();
                uploadedUrls.push(downloadURL);
            }

            return uploadedUrls;
        }

        // Remove image from preview
        function removeImage(index) {
            currentEditingDeal.images.splice(index, 1);

            const previewGrid = document.getElementById('image-preview-grid');
            previewGrid.innerHTML = currentEditingDeal.images.map((img, i) => `
        <div class="relative group">
            <img src="${img}" alt="Car" class="w-full h-32 object-cover rounded-lg border">
            <button type="button" onclick="removeImage(${i})" 
                class="absolute top-2 right-2 bg-red-600 text-white rounded-full w-6 h-6 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity">
                <i class="fas fa-times text-xs"></i>
            </button>
        </div>
    `).join('');

            if (currentEditingDeal.images.length === 0) {
                previewGrid.classList.add('hidden');
            }
        }

        // Add New Deal
        document.getElementById('add-new-deal-btn').addEventListener('click', () => {
            currentEditingDeal = {
                id: null,
                car: { make: '', name: '' },
                details: {
                    label: '',
                    mileage: '',
                    term: '',
                    exteriorColor: '',
                    interiorColor: '',
                    features: ''
                },
                pricing: {
                    price: '',
                    due: 0
                },
                images: [],
                status: 'active',
                timestamp: new Date()
            };

            isEditMode = true;
            renderModalContent();
            document.querySelector('#details-modal h2').textContent = 'Add New Deal';

            const scrollbarWidth = window.innerWidth - document.documentElement.clientWidth;
            document.body.style.paddingRight = `${scrollbarWidth}px`;
            document.body.style.overflow = 'hidden';

            const modal = document.getElementById('details-modal');
            modal.style.display = 'flex';

            setupModalEventListeners();
        });

        function renderModalContent() {
            const deal = currentEditingDeal;
            const content = document.getElementById('modal-content');

            if (isEditMode) {
                content.innerHTML = `
                    <div class="space-y-6">
                        <!-- Status -->
                        <section class="space-y-4">
                            <div class="flex items-center justify-between p-4 bg-gray-50 rounded-lg">
                                <div>
                                    <h3 class="text-lg font-semibold text-gray-900">Status</h3>
                                    <p class="text-sm text-gray-500">Toggle to activate or deactivate this deal</p>
                                </div>
                                <label class="relative inline-flex items-center cursor-pointer">
                                    <input type="checkbox" id="edit-status" class="sr-only peer" ${deal.status === 'active' ? 'checked' : ''}>
                                    <div class="w-14 h-7 bg-gray-200 rounded-full peer-checked:bg-blue-600 transition-all duration-300"></div>
                                    <div class="absolute left-1 top-1 w-5 h-5 bg-white rounded-full shadow-md transform transition-all peer-checked:translate-x-7"></div>
                                </label>
                            </div>
                        </section>

                        <hr class="border-gray-200">

                        <!-- Car Information -->
                        <section class="space-y-4">
                        <section class="space-y-4">
                            <h3 class="text-lg font-semibold text-gray-900">Car Information</h3>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Name <span class="text-red-500">*</span></label>
                                    <input type="text" id="edit-name" value="${deal.car?.name || ''}" 
                                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-600"
                                        placeholder="e.g. BMW X5 2024">
                                </div>
                                 <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Make <span class="text-red-500">*</span></label>
                                    <input type="text" id="edit-make" value="${deal.car?.make || ''}" 
                                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-600"
                                        placeholder="e.g. BMW">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Label</label>
                                    <input type="text" id="edit-label" value="${deal.details?.label || ''}" 
                                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-600"
                                        placeholder="e.g. DEMO">
                                </div>
                            </div>
                        </section>

                        <hr class="border-gray-200">

                        <!-- Details -->
                        <section class="space-y-4">
                            <h3 class="text-lg font-semibold text-gray-900">Details</h3>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div class="space-y-2 relative">
                                    <label class="block text-sm font-medium text-gray-700">Term (months) <span class="text-red-500">*</span></label>
                                    <div class="custom-select w-full" data-placeholder="Select Term" data-name="edit-term" data-current="${deal.details?.term || ''}"
                                        data-options='["24","36","48","Other"]'>
                                    </div>
                                </div>

                                <div class="space-y-2 relative">
                                    <label class="block text-sm font-medium text-gray-700">Mileage (MPY) <span class="text-red-500">*</span></label>
                                    <div class="custom-select w-full" data-placeholder="Select Mileage" data-name="edit-mileage" data-current="${deal.details?.mileage || ''}"
                                        data-options='["7,500", "10,000","12,000","15,000","Other"]'>
                                    </div>
                                </div>

                                <div class="space-y-2 relative">
                                    <label class="block text-sm font-medium text-gray-700">Exterior Color <span class="text-red-500">*</span></label>
                                    <div class="custom-select w-full" data-placeholder="Select Exterior Color" data-name="edit-exteriorColor" data-current="${deal.details?.exteriorColor || ''}"
                                        data-options='["White","Black","Silver","Gray","Blue","Red","Green","Brown","Beige","Gold","Orange","Other"]'>
                                    </div>
                                </div>

                                <div class="space-y-2 relative">
                                    <label class="block text-sm font-medium text-gray-700">Interior Color <span class="text-red-500">*</span></label>
                                    <div class="custom-select w-full" data-placeholder="Select Interior Color" data-name="edit-interiorColor" data-current="${deal.details?.interiorColor || ''}"
                                        data-options='["Black","Beige","Brown","Gray","White","Tan","Red","Other"]'>
                                    </div>
                                </div>

                                <div class="md:col-span-2">
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Features</label>
                                    <input type="text" id="edit-features" value="${deal.details?.features || ''}" 
                                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-600"
                                        placeholder="e.g. Sunroof, Leather Seats, Navigation">
                                </div>
                            </div>
                        </section>

                        <hr class="border-gray-200">

                        <!-- Pricing -->
                        <section class="space-y-4">
                            <h3 class="text-lg font-semibold text-gray-900">Pricing</h3>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Monthly Due <span class="text-red-500">*</span></label>
                                    <div class="relative">
                                        <span class="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-500">$</span>
                                        <input type="number" id="edit-price" value="${deal.pricing?.price || ''}" 
                                            class="w-full pl-8 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-600"
                                            placeholder="0" min="0" step="10">
                                    </div>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Due At Signing <span class="text-red-500">*</span></label>
                                    <div class="relative">
                                        <span class="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-500">$</span>
                                        <input type="number" id="edit-due" value="${deal.pricing?.due || ''}" 
                                            class="w-full pl-8 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-600"
                                            placeholder="0" min="0" step="10">
                                    </div>
                                </div>
                            </div>
                        </section>

                        <hr class="border-gray-200">

                        <!-- Images -->
                        <section class="space-y-4">
                            <h3 class="text-lg font-semibold text-gray-900">Images</h3>

                            <!-- Upload Area -->
                            <div class="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center hover:border-blue-500 transition-colors">
                                <input type="file" id="image-upload" accept="image/*" multiple class="hidden">
                                <label for="image-upload" class="cursor-pointer">
                                    <i class="fas fa-cloud-upload-alt text-4xl text-gray-400 mb-2"></i>
                                    <p class="text-sm text-gray-600">Click to upload images or drag and drop</p>
                                    <p class="text-xs text-gray-500 mt-1">PNG, JPG, WEBP up to 5MB each</p>
                                </label>
                            </div>
                        
                            <!-- Image Preview Grid -->
                            <div id="image-preview-grid" class="grid grid-cols-3 gap-3 ${deal.images && deal.images.length > 0 ? '' : 'hidden'}">
                                ${deal.images && deal.images.length > 0 ? deal.images.map((img, index) => `
                                    <div class="relative group">
                                        <img src="${img}" alt="Car" class="w-full h-32 object-cover rounded-lg border">
                                        <button type="button" onclick="removeImage(${index})" 
                                            class="absolute top-2 right-2 bg-red-600 text-white rounded-full w-6 h-6 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity">
                                            <i class="fas fa-times text-xs"></i>
                                        </button>
                                    </div>
                                `).join('') : ''}
                            </div>
                            <div id="upload-status" class="text-sm text-gray-600 hidden"></div>
                        </section>
                    </div>
                `;

                document.getElementById('edit-btn').style.display = 'none';
                document.getElementById('edit-actions').classList.remove('hidden');
                document.getElementById('edit-actions').classList.add('flex');

                // Initialize custom selects after rendering
                initializeEditCustomSelects();

            } else {
                content.innerHTML = `
                    <div class="space-y-6">
                         <!-- Status -->
                        <section>
                            <div class="">
                                <span class="status-badge status-${deal.status}">
                                    ${(deal.status || 'pending').charAt(0).toUpperCase() + (deal.status || 'pending').slice(1)}
                                </span>
                            </div>
                        </section>

                        <!-- Car Information -->
                        <section>
                            <h3 class="font-semibold text-lg mb-2">Car Information</h3>
                            <div class="bg-gray-50 rounded-lg p-4">
                                <div class="space-y-2 text-sm">
                                    <div><span class="font-medium">Name:</span> ${deal.car?.name || '-'}</div>
                                    <div><span class="font-medium">Make:</span> ${deal.car?.make || '-'}</div>
                                    <div><span class="font-medium">Label:</span> ${deal.details?.label || '-'}</div>
                                </div>
                            </div>
                        </section>

                        <hr class="border-gray-200">

                        <!-- Details -->
                        <section>
                            <h3 class="font-semibold text-lg mb-2">Details</h3>
                            <div class="bg-gray-50 rounded-lg p-4">
                                <div class="grid grid-cols-2 gap-3 text-sm mb-3">
                                    <div><span class="font-medium">Term:</span> ${deal.details?.term || '-'} months</div>
                                    <div><span class="font-medium">Mileage:</span> ${deal.details?.mileage || '-'}</div>
                                    <div><span class="font-medium">Exterior:</span> ${deal.details?.exteriorColor || '-'}</div>
                                    <div><span class="font-medium">Interior:</span> ${deal.details?.interiorColor || '-'}</div>
                                </div>
                                <div class="text-sm">
                                    <span class="font-medium">Features:</span> ${deal.details?.features || '-'}
                                </div>
                            </div>
                        </section>

                        <hr class="border-gray-200">

                        <!-- Pricing -->
                        <section>
                            <h3 class="font-semibold text-lg mb-2">Pricing</h3>
                            <div class="bg-gray-50 rounded-lg p-4">
                                <div class="space-y-2 text-sm">
                                    <div><span class="font-medium">Monthly Due:</span> $${deal.pricing?.price || '-'}</div>
                                    <div><span class="font-medium">Due At Signing:</span> $${deal.pricing?.due || '-'}</div>
                                </div>
                            </div>
                        </section>

                        <hr class="border-gray-200">

                        <!-- Images -->
                        <section>
                            <h3 class="font-semibold text-lg mb-2">Images</h3>
                            ${deal.images && deal.images.length > 0 ? `
                                <div class="grid grid-cols-3 gap-2">
                                    ${deal.images.map(img => `
                                        <a href="${img}" target="_blank" class="block">
                                            <img src="${img}" alt="Car" class="bg-gray-50 w-full h-40 object-contain rounded">
                                        </a>
                                    `).join('')}
                                </div>
                            ` : '<p class="text-sm text-gray-500">No images available</p>'}
                        </section>

                          <!-- Timestamp -->
                        <div class="text-right text-xs text-gray-500 px-3 py-2 rounded-lg inline-block">
                            Created: ${formatDateTime(deal.timestamp)}
                        </div>
                    </div>
                `;

                document.getElementById('edit-btn').style.display = 'block';
                document.getElementById('edit-actions').classList.add('hidden');
            }
        }

        function initializeEditCustomSelects() {
            let openDropdown = null;

            document.querySelectorAll('.custom-select').forEach(container => {
                const placeholder = container.dataset.placeholder;
                const options = JSON.parse(container.dataset.options);
                const name = container.dataset.name;
                const currentValue = container.dataset.current || '';

                // Store selected value
                container.selectedValue = currentValue;

                // Create selected box
                const selectBox = document.createElement('div');
                selectBox.className = 'w-full px-4 py-3 border border-gray-300 rounded-lg cursor-pointer flex justify-between items-center focus:outline-none focus:ring-2 focus:ring-cream-900 transition-all duration-200';
                selectBox.innerHTML = `<span>${currentValue || placeholder}</span><i class="fas fa-chevron-down text-gray-500 transition-transform duration-200"></i>`;
                container.appendChild(selectBox);

                // Create options container
                const optionsContainer = document.createElement('div');
                optionsContainer.className = 'absolute z-10 w-full bg-white border border-gray-300 rounded-lg shadow-lg max-h-60 overflow-y-auto hidden custom-scroll';

                options.forEach(opt => {
                    const optionDiv = document.createElement('div');
                    optionDiv.className = 'px-4 py-2 hover:bg-gray-100 cursor-pointer text-sm';
                    optionDiv.textContent = opt;
                    if (opt.toLowerCase() === 'other') optionDiv.dataset.other = true;
                    optionsContainer.appendChild(optionDiv);
                });
                container.appendChild(optionsContainer);

                const selectedSpan = selectBox.querySelector('span');
                const chevron = selectBox.querySelector('i');

                // Toggle dropdown
                selectBox.addEventListener('click', (e) => {
                    e.stopPropagation();

                    // Close any other open dropdown
                    if (openDropdown && openDropdown !== optionsContainer) {
                        openDropdown.classList.add('hidden');
                        const otherChevron = openDropdown.previousSibling?.querySelector('i');
                        if (otherChevron) otherChevron.classList.remove('rotate-180');
                    }

                    optionsContainer.classList.toggle('hidden');
                    chevron.classList.toggle('rotate-180');
                    openDropdown = optionsContainer.classList.contains('hidden') ? null : optionsContainer;
                });

                optionsContainer.querySelectorAll('div').forEach(option => {
                    option.addEventListener('click', (e) => {
                        e.stopPropagation();

                        if (option.dataset.other) {
                            const category = placeholder.replace(/^Select\s+/i, '');
                            const input = document.createElement('input');
                            input.type = 'text';
                            input.placeholder = `Enter other ${category.toLowerCase()}`;
                            input.className = 'w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-cream-900 transition-all duration-200';
                            input.value = currentValue && !options.includes(currentValue) ? currentValue : '';
                            selectBox.replaceWith(input);
                            optionsContainer.classList.add('hidden');
                            chevron.classList.remove('rotate-180');

                            input.focus();

                            input.addEventListener('blur', () => {
                                if (input.value.trim() === '') {
                                    container.selectedValue = '';
                                    container.innerHTML = '';
                                    container.appendChild(selectBox);
                                    container.appendChild(optionsContainer);
                                    selectedSpan.textContent = placeholder;
                                } else {
                                    container.selectedValue = input.value.trim();
                                    selectedSpan.textContent = input.value;
                                    container.innerHTML = '';
                                    container.appendChild(selectBox);
                                    container.appendChild(optionsContainer);
                                }
                            });
                        } else {
                            container.selectedValue = option.textContent;
                            selectedSpan.textContent = option.textContent;
                            optionsContainer.classList.add('hidden');
                            chevron.classList.remove('rotate-180');
                        }

                        openDropdown = null;
                    });
                });
            });

            // Close dropdowns when clicking outside
            document.addEventListener('click', () => {
                if (openDropdown) {
                    openDropdown.classList.add('hidden');
                    const chevron = openDropdown.previousSibling?.querySelector('i');
                    if (chevron) chevron.classList.remove('rotate-180');
                    openDropdown = null;
                }
            });

            // Toggle status switch
            const statusToggle = document.getElementById('edit-status');
            const statusText = document.getElementById('status-text');
            if (statusToggle && statusText) {
                statusToggle.addEventListener('change', function () {
                    statusText.textContent = this.checked ? 'Active' : 'Inactive';
                    statusText.className = `text-sm font-medium ${this.checked ? 'text-blue-600' : 'text-gray-600'}`;
                });
            }
        }

        // Delete
        let deleteTargetId = null;

        async function deleteListing(id) {
            deleteTargetId = id;
            const modal = document.getElementById('delete-modal');
            modal.classList.remove('hidden');
            modal.classList.add('flex');
        }

        document.getElementById('cancel-delete').addEventListener('click', () => {
            const modal = document.getElementById('delete-modal');
            modal.classList.remove('flex');
            modal.classList.add('hidden');
            deleteTargetId = null;
        });

        document.getElementById('confirm-delete').addEventListener('click', async () => {
            if (!deleteTargetId) return;

            try {
                await db.collection(COLLECTION_NAME).doc(deleteTargetId).delete();
                alert('Deal deleted successfully');

                const modal = document.getElementById('delete-modal');
                modal.classList.remove('flex');
                modal.classList.add('hidden');
                deleteTargetId = null;

                loadDeals();
            } catch (error) {
                console.error('Error deleting deal:', error);
                alert('Failed to delete deal');
            }
        });

        // Export CSV
        document.getElementById('export-csv').addEventListener('click', () => {
            const csv = convertToCSV(filteredDeals);
            downloadFile(csv, 'car-deals-export.csv', 'text/csv');
        });

        function convertToCSV(data) {
            const headers = ['Status', 'Car Name', 'Make', 'Label', 'Monthly Price', 'Term', 'Mileage', 'Due', 'Exterior', 'Interior', 'Features'];

            const rows = data.map(deal => [
                deal.status || 'pending',
                deal.car?.name || '',
                deal.car?.make || '',
                deal.details?.label || '',
                deal.pricing?.price || '',
                deal.details?.term || '',
                deal.details?.mileage || '',
                deal.pricing?.due || '',
                deal.details?.exteriorColor || '',
                deal.details?.interiorColor || '',
                deal.details?.features || ''
            ]);

            return [
                headers.join(','),
                ...rows.map(row => row.map(cell => `"${cell}"`).join(','))
            ].join('\n');
        }

        function downloadFile(content, filename, type) {
            const blob = new Blob([content], { type });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.click();
            window.URL.revokeObjectURL(url);
        }
    </script>
</body>

</html>